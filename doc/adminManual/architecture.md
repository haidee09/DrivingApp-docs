## Arquitectura del sistema de DrivingApp

The architecture of the DrivingApp system is composed of two layers: the fronted and the backend. The following image shows the components of the architecture in each of its layers.

![Arquitectura del sistema DrivingApp](./img/architecture.png)

### Fronted

The Frontend layer of the DrivingApp system contains the end-user applications. The architecture shows in the Fronted layer the mobile application DrivingApp, however if you want to add another application to this project, you can include it within the Frontend layer.

The mobile application DrivingApp constantly sends **(1)** to the Orion ContextBroker the device data, and the alert entities created by the user of the application. In addition, the DrivingApp application uses **(2)** the services of DrivingApp Service to perform queries functions and data models administration. 

### Backend

The Backend layer is composed by the services and DBMS that the DrivingApp application uses. The services can be broadly classified into three types: the QuantumLeap environment services, the specific use services for the DrivingApp application and the IDM-Keyrock authentication service.

#### Servicios del Entorno QuantumLeap

The QuantumLeap environment is a set of services that allow you to store FIWARE-NGSIv2 data in time series, and represent them graphically to facilitate their monitoring. The services that make up the QuantumLeap environment are described below.

##### Orion ContextBroker

The Orion ContextBroker is a C ++ implementation of the NGSIv2 REST API developed as part of the FIWARE platform. This component allows managing the entire life cycle of the context information and its availability; including updates, queries, registrations and subscriptions. Using the Orion ContextBroker, it is possible to create context elements and manage them through updates and queries. In addition, with the Orion ContextBroker it is possible to subscribe applications to changes in the context information; e.g, when new context information is created or updated, applications receive notification. The Orion ContextBroker stores the context information in a MongoDB database. The usage scenarios and the functions of the Orion ContextBroker are described in the official documentation of this component, which you can consult in the following [link] (https://fiware-orion.readthedocs.io/en/master/) 

The Orion ContextBroker manages the context information of the devices of DrivingApp users application, and also the alerts generated by these users **(2)**.
The device context and alert information stored in the Orion ContextBroker is constantly queried **(3)** by DrivingApp Service.

The Orion ContextBroker establishes communication ** (4) ** with the QuantumLeap API to send the data of the Device and Alert entities registered in the Orion. The communication between the Orion ContextBroker and the QuantumLeap API is configured through two subscriptions, one for the Device entities and another for the Alert entities. Each of these subscriptions indicates: the address of the QuantumLeap API to which the Orion ContextBroker sends the entity, and the specific attributes of the entity to store them in the CrateDB database. To learn more about subscriptions, you can consult the [Subscriptions] (https://fiware-orion.readthedocs.io/en/master/user/walkthrough_apiv2/index.html#subscriptions) section of the Orion ContextBroker documentation.

The Orion ContextBroker notifies **(5)** to Notifications Service when a new alert entity is created. The notification sent by the Orion ContextBroker to the Notification Sevice service is configured through the creation of a subscription, this indicates: the type of entities to which the subscription applies (entities of type Alert), the address of Notifications Service and the attributes that entities of type Alert must contain.

##### QuantumLeap API

QuantumLeap API es la primera implementación de una API escrita en Python que soporta el almacenamiento de datos FIWARE-NGSIv2 en una base de datos de series de tiempo. Si se desea aprender más acerca de  QuantumLeap puede consultar su documentación oficial en el este [enlace](https://quantumleap.readthedocs.io/en/latest/).

La API de QuantumLeap recibe los datos notificados por el Orion ContextBroker y los convierte a los tipos de datos soportados por CrateDB, para su almacenamiento en la base de datos.

##### CrateDB

CrateDB es un sistema de administración de bases de datos SQL distribuidas, e integra un almacén de datos orientado a documentos con capacidad de búsqueda. Es de código abierto y escrito en Java. Para conocer más acerca de CrateDB puede consultar su documentación en el siguiente [enlace](https://crate.io/docs/).

##### Grafana

Grafana es una aplicación web que sirve para monitorear grandes conjuntos de datos, a través de la creación de gráficos que interpretan en tiempo real  los datos obtenidos de diversas fuentes de datos. Para conocer más acerca de Grafana, consulte su documentación oficial en el siguiente [enlace](http://docs.grafana.org/).

#### Servicios de uso específico para DrivingApp

Los servicios diseñados para uso la aplicación DrivingApp son dos servicios web descritos brevemente a continuación. 

##### DrivingApp Service

DrivingApp Service es un servicio web que manipula los modelos de datos públicos y privados de la aplicación móvil, además de proporcionar servicios de consulta. Para mayor información consulte la sección [Servicios Web](./webServices.md#servicios-web).

##### Notifications Service

Notifications Service es un servicio web que manipula la información de las entidades de Alerta enviadas por el Orion ContextBroker a través de la notificación de una suscripción. Para más información consulte la sección [Servicios Web](./webServices.md#servicios-web).

#### Servicio de Autenticación de FIWARE

El IDM- Keyrock es un habilitador genérico de FIWARE que ofrece herramientas de administración para soportar las funciones del ciclo de vida del usuario como: acceso a redes, servicios y aplicaciones, incluida la autenticación segura y privada de usuarios a dispositivos, redes y servicios. Además, Identity Management se utiliza para autorizar a servicios extranjeros a acceder a datos personales almacenados en un entorno seguro. Por lo general, el propietario de los datos debe dar su consentimiento para acceder a los datos; esto implica también la autenticación del usuario. Para más información de este componente consulte su documentación en este [enlace](https://github.com/ging/fiware-idm-deprecated).
